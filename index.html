<script src="node_modules/socket.io-client/dist/socket.io.js"></script>
<script>
  const socket = io('http://localhost:8013');

  const state = {};

  socket.on('init', (data) => {
    console.log('init', data);
  });

  socket.on('action_ack', (action) => {
    console.log('action_ack', action);

    switch (action) {
    case 'left_down':
      state.left = 2;
      break;
    case 'right_down':
      state.right = 2;
      break;
    case 'left_up':
      state.left = 0;
      break;
    case 'right_up':
      state.right = 0;
      break;
    }
  });

  window.onload = () => {
    const surface = document.getElementById('surface');

    surface.width = surface.clientWidth;
    surface.height = surface.clientHeight;

    const ctx = surface.getContext('2d');

    function paint() {
      requestAnimationFrame(paint);

      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, surface.width, surface.height);

      if (state.left) {
        ctx.fillStyle = state.left === 2 ? 'white' : 'gray';
        ctx.fillRect(0, 0, surface.width / 2, surface.height);
      }

      if (state.right) {
        ctx.fillStyle = state.right === 2 ? 'white' : 'gray';
        ctx.fillRect(surface.width / 2, 0, surface.width / 2, surface.height);
      }
    }

    requestAnimationFrame(paint);

    function emitAction(action) {
      console.log('action', action);
      socket.emit('action', action);

      switch (action) {
      case 'left_down':
        state.left = 1;
        break;
      case 'right_down':
        state.right = 1;
        break;
      case 'left_up':
        state.left = 1;
        break;
      case 'right_up':
        state.right = 1;
        break;
      }
    }

    surface.addEventListener('mousedown', onMouseDown);
    surface.addEventListener('mouseup', onMouseUp);

    function onMouseDown(evt) {
      const normX = evt.clientX / surface.clientWidth;
      const normY = evt.clientY / surface.clientHeight;

      if (Math.abs(normY - 0.5) < 0.25 && Math.abs(normX - 0.5) > 0.25) {
        if (normX < 0.5) {
          emitAction('left_down');
        } else {
          emitAction('right_down');
        }
      }
    }

    function onMouseUp(evt) {
      const normX = evt.clientX / surface.clientWidth;
      const normY = evt.clientY / surface.clientHeight;

      if (Math.abs(normY - 0.5) < 0.25 && Math.abs(normX - 0.5) > 0.25) {
        if (normX < 0.5) {
          emitAction('left_up');
        } else {
          emitAction('right_up');
        }
      }
    }
  };
</script>
<style>
html, body { height: 100% }
body { display: flex; margin: 0; padding: 0; }
#surface { flex: 1; }
</style>
<canvas id="surface"></canvas>
